outdir=./geo0.1b
train_file="./geo0.1b/geo_0.1b.fvecs"
dim=96
k=2048
thread_num=56
normalize_before_train='false'
[ $# -gt 0 ] && thread_num=$1
lpq_dir=$outdir/lpq_k${k}_minus
mkdir -p $lpq_dir

#./gen_init_data --normalize_before_train=${normalize_before_train} --train_file=${train_file} --n=30000000 --use_yael=true --iter_num=60 --thread_num=${thread_num} --d=$dim --k=$k --coarse_centriods_file=$outdir/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs --residual_centriods_file=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs &>$outdir/log.init.yael.k${k}_residual_opq.sift1b 

#train a
#./learnGNOIMI --normalize_before_train=${normalize_before_train} --n=0 --d=$dim -train_lopq=false --train_opq=true --direct_train_s_t_alpha=true --train_pq=true --pq_minus_mean=true --thread_num=${thread_num} --k=${k} --learnIterationsCount=60 --outputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --pqOutputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --initCoarseFilename=${outdir}/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs --initFineFilename=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs   --learnFilename=${train_file} --lpq_file_prefix={lpq_dir}/ &>$outdir/log.learn_yael_opq_k${k}_residual_opq.gopq_minus_mu

#train lopq
#./learnGNOIMI --normalize_before_train=${normalize_before_train} --n=0 --d=$dim -train_lopq=true --train_opq=false --direct_train_s_t_alpha=false --train_pq=false --pq_minus_mean=true --thread_num=${thread_num} --k=${k} --learnIterationsCount=60 --outputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --pqOutputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --initCoarseFilename=${outdir}/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs     --initFineFilename=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs   --learnFilename=${train_file} --lpq_file_prefix=${lpq_dir}/  -lopq_train_coarse_start=0   -lopq_train_coarse_end=512 &>$outdir/log.learn_yael_opq_k${k}_residual_opq.lopq_minus_mu_0_512
#./learnGNOIMI --normalize_before_train=${normalize_before_train} --n=0 --d=$dim -train_lopq=true --train_opq=false --direct_train_s_t_alpha=false --train_pq=false --pq_minus_mean=true --thread_num=${thread_num} --k=${k} --learnIterationsCount=60 --outputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --pqOutputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --initCoarseFilename=${outdir}/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs     --initFineFilename=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs   --learnFilename=${train_file} --lpq_file_prefix=${lpq_dir}/  -lopq_train_coarse_start=512   -lopq_train_coarse_end=1024 &>$outdir/log.learn_yael_opq_k${k}_residual_opq.lopq_minus_mu_512_1024
#./learnGNOIMI --normalize_before_train=${normalize_before_train} --n=0 --d=$dim -train_lopq=true --train_opq=false --direct_train_s_t_alpha=false --train_pq=false --pq_minus_mean=true --thread_num=${thread_num} --k=${k} --learnIterationsCount=60 --outputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --pqOutputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --initCoarseFilename=${outdir}/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs     --initFineFilename=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs   --learnFilename=${train_file} --lpq_file_prefix=${lpq_dir}/  -lopq_train_coarse_start=1248   -lopq_train_coarse_end=1536 &>$outdir/log.learn_yael_opq_k${k}_residual_opq.lopq_minus_mu_1024_1536
#./learnGNOIMI --normalize_before_train=${normalize_before_train} --n=0 --d=$dim -train_lopq=true --train_opq=false --direct_train_s_t_alpha=false --train_pq=false --pq_minus_mean=true --thread_num=${thread_num} --k=${k} --learnIterationsCount=60 --outputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --pqOutputFilesPrefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --initCoarseFilename=${outdir}/coarse_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs     --initFineFilename=${outdir}/fine_centroids_init_d${d}_k${k}_residual_opq_yael.fvecs   --learnFilename=${train_file} --lpq_file_prefix=${lpq_dir}/  -lopq_train_coarse_start=1536   -lopq_train_coarse_end=2048 &>$outdir/log.learn_yael_opq_k${k}_residual_opq.lopq_minus_mu_1536_2048

#index lopq
#./search_GNOIMI_deco --D=$dim -threadsCount=1 --pq_minus_mean=true --K=${k} --residual_opq=true --lpq_file_prefix=${lpq_dir}/ --pq_prefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --model_prefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --index_prefix=${lpq_dir}/index_k${k}_0.5b_residual_opq_lopq_lpq_minus_decom_ --query_filename=${train_file} --base_file=${train_file} --groud_truth_file=sift1B/sift_groundtruth.ivecs --N=100000  --queriesCount=10000 --nprobe=2000 --neighborsCount=100000 --L=32 --make_index=true --dump_mmu_model=true --normalize_before_read=false

#search lopq
./search_GNOIMI_deco --D=$dim -threadsCount=1 --pq_minus_mean=true --K=${k} --residual_opq=true --lpq_file_prefix=${lpq_dir}/ --pq_prefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_minus_mu_ --model_prefix=${lpq_dir}/learn_from_yael_k${k}_residual_opq_ --index_prefix=${lpq_dir}/index_k${k}_0.5b_residual_opq_lopq_lpq_minus_decom_ --query_filename=${train_file} --base_file=${train_file} --groud_truth_file=sift1B/sift_groundtruth.ivecs --N=100000  --queriesCount=10 --nprobe=2000 --neighborsCount=100000 --L=32 --make_index=false --dump_mmu_model=false --normalize_before_read=false
